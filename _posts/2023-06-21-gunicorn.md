---
layout: post
title: "Gunicorn from scratch"
date: 2023-06-23
published: true
author: victor
tags:
  - gunicorn
  - basics
categories:
  - Production deployment
---

When you create a new Django project with `django-admin startproject`, it automatically creates a `wsgi.py` file for you.
This is a module containing a WSGI application object called `application` that can be called by any type of WSGI server.
Here is how this works.

## The simplest WSGI application

*WSGI*: stands for *Web Server Gateway Interface*. It is an interface specification by which server and application communicate.
The application provides a function which the server calls for each request:

```python
def application(environ, start_response):
    ...
```

* `environ` is a Python dictionary containing the CGI-defined environment variables plus a few extras.
* `start_response` is a callback by which the application returns the HTTP headers.

  ```python
  start_response(status, response_headers)
  ```

* `status` is an HTTP status string (e.g., "200 OK")
* `response_headers` is a list of 2-tuples, the HTTP headers in key-value format

The application function then returns an iterable of body chunks, that need to be bytes, e.g. `[b"<html>Hello, world!</html>"]`.
So the simplest WSGI application can be:

```python
def application(environ, start_response):
    start_response("200 OK", [])
    return [b"<html>Hello, world!</html>"]
```

## Gunicorn

Normally during development you use `python manage.py runserver` to start a web server, but it is not the recommended way in production<sup>[[1](https://docs.djangoproject.com/en/dev/ref/django-admin/#runserver)]</sup>.
Basically it is also a WSGI application that has some additional features such as reloading on code changes, but it has not gone through security audits or performance tests.

Gunicorn stands for **â€˜Green Unicornâ€™** and is a Python WSGI HTTP Server for UNIX. 
It has no dependencies and can be installed with _pip_ or _poetry_:

```bash
poetry add gunicorn
```

Assuming you have a project structure like this:

```
.
â”œâ”€â”€ manage.py
â””â”€â”€ project
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ asgi.py
    â”œâ”€â”€ settings.py
    â”œâ”€â”€ urls.py
    â””â”€â”€ wsgi.py
```
{:style="border: 1px solid black; line-height: 1.1"}

you can run

```bash
gunicorn project.wsgi:application
```

inside your project directory and it will spawn two processes that you can see when you call `ps aux | grep gunicorn`. 
One of them is the parent process that controlls all the workers, the other one is the process for the worker. By default it will only spawn one worker and listen to HTTP requests on `127.0.0.1:8000`.

## Configure Gunicorn

Gunicorn detects if there is any file called `gunicorn.conf.py` inside the directory where it is executed, or you can specify a different path with the `-c` flag.
The simplest way is to place it next to your manage.py file:

```
.
â”œâ”€â”€ manage.py
â”œâ”€â”€ gunicorn.conf.py    <--- create here
â””â”€â”€ project
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ asgi.py
    â”œâ”€â”€ settings.py
    â”œâ”€â”€ urls.py
    â””â”€â”€ wsgi.py
```
{:style="border: 1px solid black; line-height: 1.1"}

### Multiple workers

You can spawn multiple gunicorn processes that will serve your application to make use of the computing power of your server, based on the number of CPUs the machine has.
To find out the number of processors on your UNIX machine, you can execute [`grep -c ^processor /proc/cpuinfo`](https://stackoverflow.com/questions/6481005/how-to-obtain-the-number-of-cpus-cores-in-linux-from-the-command-line).
Gunicorn suggests to run `2-4 x $(NUM_CORES)` of workers<sup>[[2](https://docs.gunicorn.org/en/stable/settings.html#workers)]</sup>.
The reasoning behind it is that, while one of the processes is occupied with handling I/O or waiting for a response from the database, the other one can take over and handle a new request.

Here is how the `gunicorn.conf.py` file might look like:

```python
import multiprocessing

workers = multiprocessing.cpu_count() * 2 + 1
```

### Listen to different IPs

By default the Gunicorn process will listen for http request on `127.0.0.1:8000`.
You can configure Gunicorn to listen to different ports, or even to a public IP address.
You can easily test this by finding out your computer's IP address inside your local network with `ifconfig`  and set the bind address in the `gunicorn.conf.py` file like this:

```python
bind = "192.168.x.y:8000"
```

and navigate from your phone to your computer with this address. 
Ports smaller than 1024 require additional configuration.

In case you plan to use a proxy server like Nginx on the same machine, you might consider using a socket for proxying requests to your Gunicorn server.

```python
bind = "unix:/path/to/myproject.sock"
```

This has slight performance advantages, since they can avoid some checks and operations (like routing)<sup>[[3](https://serverfault.com/questions/124517/what-is-the-difference-between-unix-sockets-and-tcp-ip-sockets/124518#124518)]</sup>.

You can even specify multiple bind addresses as a list, which is especially useful if you want to serve your application through *HTTPS*.

```python
bind = [
    "192.168.x.y:80",
    "192.168.x.y:443"
]
```

Serving requests will require an SSL certificate, which deserves another post to be discussed in detail.

## Run Gunicorn as a background process

To run the *Gunicorn* process in the background, you need to configure *Supervisor* or *Systemd*.
There are plenty articles online that explain how to configure both of them with *Gunicorn*, but after doing the reasearch I consider *Supervisor* to be the more versatile and simpler one to configure, even though *Systemd* is probably already installed on your Linux distribution.

To install *Supervisor* you need to execute

```bash
sudo apt-get -y install supervisor
sudo systemctl enable supervisor
sudo systemctl start supervisor
```

*Supervisor* comes with an HTTP Server you can enable by specifying the [[inet_http_server]](http://supervisord.org/configuration.html#inet-http-server-section-values) setting inside `/etc/supervisor/supervisord.conf`:

```
[inet_http_server]
port = 9001
```

and restarting the service with `sudo supervisorctl reload`.

Now you can create a new file inside `/etc/supervisor/conf.d/` called `my_app.conf`:

```init
[program:my_app]
directory=/srv/%(program_name)s
command=/srv/%(program_name)s/run
stderr_logfile=/var/log/supervisor/%(program_name)s_stderr.log
stdout_logfile=/var/log/supervisor/%(program_name)s_stdout.log
```
{:class="file-content"}

> ## ðŸ¤« Tip
> By default, *Supervisor* rotates your log files, but you can also configure it to run with [*Logrotate*](https://medium.com/@doodyp/easy-logging-with-logrotate-and-supervisord-16b72b79ded0).

After you saved the file, you can instruct *Supervisor* to reload the configuration:

```bash
sudo supervisorctl reread
sudo supervisorctl update
```

Now your app is up and running on the port specified by the *Gunicorn* **bind** address.


## Further Reading
* [docs.gunicorn.org][gunicorn]: *Gunicorn* documentation
* [Digitalocean](digitalocean): Comprehensive tutorial on how to set up a *Django* application with *Gunicorn* and *Nginx*
* [simpleisbetterthancomplex.com](simpleisbetterthancomplex): Last step of an overall great Django tutorial that also shows how to configure Gunicorn and Nginx for production deployment
* [WSGI Servers][fullstackpython]: A more detailed explanation on WSGI servers and other Gunicorn alternatives
* More WSGI learning resources: [wsgi.readthedocs.io][wsgi]

[wsgi]: https://wsgi.readthedocs.io/en/latest/
[gunicorn]: https://docs.gunicorn.org/en/stable/index.html
[simpleisbetterthancomplex]: https://simpleisbetterthancomplex.com/series/2017/10/16/a-complete-beginners-guide-to-django-part-7.html
[digitalocean]: https://www.digitalocean.com/community/tutorials/how-to-set-up-django-with-postgres-nginx-and-gunicorn-on-ubuntu-16-04
[fullstackpython]: https://www.fullstackpython.com/wsgi-servers.html
